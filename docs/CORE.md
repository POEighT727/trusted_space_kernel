# 可信数据空间内核 - 核心模块说明

## 概述

我们设计的可信数据空间内核主要分为四个核心模块：安全认证、管控模块、流通调度、存证溯源。最终要实现内核标准化、轻量化，外延灵活易扩展的目标。

---

## 一、安全认证模块

### 1.1 核心构想

安全认证模块采用**基于证书的双向认证（mTLS）机制**，构建零信任安全架构。核心理念是：**任何实体在建立连接前都必须证明自己的身份，且每次通信都需要验证身份的真实性**。

### 1.2 证书体系架构

- **根证书（CA Certificate）**：自签名的根证书，作为整个信任体系的锚点，有效期通常为10年（之后若扩展到多个可信数据空间互联的情景，需要一个外部可信CA来签发）
- **服务端证书（Server Certificate）**：内核服务端持有的证书，由CA签发，用于向连接器证明内核身份
- **客户端证书（Client Certificate）**：每个连接器持有的证书，由CA签发，证书的CommonName字段必须与连接器ID一致

### 1.3 mTLS

**客户端认证服务端：**
- 连接器在连接时验证内核服务端证书
- 确保连接的是合法的内核服务，而非中间人
- 通过CA根证书验证服务端证书的合法性

**服务端认证客户端：**

- 内核在建立连接时强制要求客户端提供证书
- 验证证书的有效期、用途等属性

**大致过程**

- 先生成CA根证书（无可信CA机构的情况）
  - 生成ca.key 
  - 用 ca.key 自签生成 ca.crt
- 每个实体也生成自己的私钥
  - connector.key,kernel.key......
- 用各自公钥生成 CSR并用私钥签名
  - connector.csr,kernel.csr......
- 用 CA 对 CSR 进行签发，生成实体证书
  - 用 ca.crt + ca.key 签发得到connector.crt,kernel.crt......
- 材料准备完成后才能进行mtls相关过程

---

## 二、流通调度模块

### 3.1 核心构想

流通调度模块采用**频道（Channel）**来管理数据传输。频道是一个**逻辑上的数据传输管道**，并非直接连接发送方和接收方，而是提供数据的中转、缓冲和分发能力。

### 3.2 频道对象

**基本属性：**

- **唯一标识**：每个频道有全局唯一的频道ID（UUID）
- **参与方**：明确的发送方ID和接收方ID
- **状态**：Active或Closed

**核心组件：**

- **数据管道**：缓冲待分发的数据包（通常容量1000个数据包）
- **订阅者表**：维护订阅该频道的所有接收方通道
- **分发协程**：后台协程负责将数据从队列分发到所有订阅者

### 3.3 数据流转机制

**发布-订阅模式：**

频道采用订阅机制实现数据流转：

1. **频道创建**：发送方请求创建频道
   - 内核在创建时验证请求者是否为合法的发送方
   - 发送方在创建时指定接收方，这可能需要维护一个目录服务（比如之后的注册表），支持动态发现空间中其他连接器的ID，这样灵活性更高
   - 最简单的方式就是静态配置，直接在配置文件中写死目标ID，或者是双方线下沟通协商，再进行配置。但本质上都是静态的，灵活性很差
2. **数据订阅**：内核通知接收方订阅频道，获得数据通道
   - 订阅时验证订阅者是否为合法的接收方
   - 每个订阅者获得独立的缓冲通道（容量100个数据包）
   - 支持多个接收方同时订阅同一频道（广播模式）
3. **数据推送**：发送方将数据包推送到频道的缓冲队列（暂时想的是队列，总之就是一个起到管道传输作用的对象）
4. **数据分发**

# TBD...

---

## 三、管控模块

### 2.1 核心构想

管控模块负责**连接器的身份管理和数据传输的权限控制**。采用**注册表+权限策略**双重管控机制。

### 2.2 身份注册表机制

**连接器生命周期管理：**

身份注册表维护每个连接器的完整生命周期信息，包括：

- **身份信息**：连接器ID、实体类型、公钥
- **状态信息**：在线/离线状态、最后心跳时间、注册时间等
- **会话信息**：会话令牌（token）、连接状态

**健康检查机制（心跳检查）**：

**心跳机制概述：**

采用客户端定期发送心跳、服务端监控心跳的双向健康检查机制，确保连接器状态的实时监控和异常及时发现。

**客户端心跳发送：**
- **发送频率**：每15秒发送一次心跳
- **心跳内容**：包含连接器ID和时间戳
- **自动重连**：心跳失败时记录警告但不停服务

**服务端心跳监控：**
- **在线判断**：30秒内收到心跳即为在线
- **离线检测**：超过1分钟无心跳标记为离线
- **状态转换**：活跃/非活跃状态 → 离线状态

**状态管理逻辑：**
- **注册时**：新连接器默认为活跃状态
- **心跳更新**：收到心跳时更新最后心跳时间
- **状态恢复**：离线连接器收到心跳后恢复活跃状态
- **定期清理**：每30秒检查并标记离线连接器

### 2.3 权限策略（ACL）

**访问控制列表（ACL）机制：**

权限策略引擎采用基于规则的访问控制，支持：

- **精确匹配规则**：`senderID:receiverID` 精确匹配
- **通配符规则**：`senderID:*` 或 `*:receiverID` 支持通配符匹配
- **优先级控制**：规则支持优先级设置，高优先级规则优先匹配
- **默认策略**：当没有匹配规则时，使用默认策略（允许/拒绝）

**规则示例：**
```go
// 允许 connector-A 向 connector-B 发送数据
policyEngine.AddRule(&PolicyRule{
    SenderID:   "connector-A",
    ReceiverID: "connector-B",
    Allowed:    true,
    Priority:   100,
})

// 允许 connector-A 向所有连接器发送数据
policyEngine.AddRule(&PolicyRule{
    SenderID:   "connector-A",
    ReceiverID: "*",
    Allowed:    true,
    Priority:   50,
})
```

### 2.4 频道创建机制

**频道创建流程：**

频道创建支持两种方式：

1. **直接创建**：通过API直接创建频道，指定发送方和接收方
2. **配置文件创建**：通过预定义的配置文件创建频道，支持复杂的频道配置

**频道状态流转：**
```
Created → Active → Closed
```

### 2.5 权限变更机制

**动态权限调整：**

频道运行过程中支持动态调整参与者权限：

- **权限变更类型**：添加/删除发送方，添加/删除接收方
- **变更流程**：通过控制消息申请权限变更，获得批准后执行变更

**访问控制流程：**

1. **频道创建时**：
   - 检查ACL权限（发送方→接收方）
   - 验证参与方状态

2. **数据传输时**：
   - 验证发送方权限
   - 检查频道活跃状态

--------------------------------------------------------------------------

## 四、存证溯源模块

### 4.1 核心构想

存证溯源模块采用**时间戳排序的哈希链记录**方式记录所有关键操作，构建**完全可审计的存证日志系统**。核心理念是：**所有关键事件都必须记录，通过数字签名确保不可抵赖性，通过哈希链确保不可篡改性**。

### 4.2 事件类型体系

模块定义了60多种事件类型，覆盖系统各个方面：

#### 数据传输事件
- `TRANSFER_START` - 数据传输开始
- `TRANSFER_END` - 数据传输结束
- `DATA_RECEIVED` - 数据接收确认
- `FILE_TRANSFER_START/END` - 文件传输事件

#### 频道管理事件
- `CHANNEL_CREATED/CLOSED` - 频道生命周期
- `CHANNEL_ACTIVATED/SUSPENDED/RESUMED` - 频道状态变化

#### 权限管理事件
- `PERMISSION_REQUEST/GRANTED/DENIED/REVOKED` - 权限控制
- `ROLE_CHANGED` - 角色变更

#### 安全事件
- `POLICY_VIOLATION/SECURITY_VIOLATION` - 安全违规
- `DATA_TAMPERING/INTEGRITY_CHECK_FAIL` - 数据安全
- `ACCESS_DENIED/SUSPICIOUS_ACTIVITY` - 异常访问

#### 身份认证事件
- `AUTH_SUCCESS/FAIL/ATTEMPT/LOGOUT` - 认证过程
- `TOKEN_GENERATED/VALIDATED/EXPIRED` - 令牌管理

#### 连接器事件
- `CONNECTOR_REGISTERED/UNREGISTERED` - 连接器生命周期
- `CONNECTOR_HEARTBEAT/ONLINE/OFFLINE` - 连接器状态
- `CONNECTOR_STATUS_CHANGED` - 状态变更

#### 证据相关事件
- `EVIDENCE_GENERATED/VERIFIED/STORED/DISTRIBUTED` - 证据处理
- `EVIDENCE_INTEGRITY_FAIL` - 完整性验证失败

#### 系统事件
- `SYSTEM_STARTUP/SHUTDOWN` - 系统生命周期
- `CONFIG_CHANGED/BACKUP_CREATED` - 配置管理
- `MAINTENANCE_START/END` - 维护操作

### 4.3 记录结构与完整性保证

每个存证记录包含完整的审计信息：

**核心字段：**
- **交易ID (TxID)**：全局唯一UUID标识
- **连接器ID**：操作发起者身份
- **事件类型**：标准化的事件分类
- **频道ID**：关联的数据传输频道
- **数据哈希**：数据内容的SHA256指纹（不存储原始数据）
- **数字签名**：RSA签名确保不可抵赖性
- **时间戳**：纳秒级精确时间记录
- **元数据**：扩展的上下文信息
- **记录哈希**：整个记录的SHA256哈希，用于完整性验证

**完整性保护机制：**
- **数字签名**：使用RSA私钥对记录内容签名
- **哈希链**：相邻记录通过哈希值链接，形成不可篡改链
- **双重验证**：既验证签名真实性，又验证内容完整性

### 4.4 存储架构

#### 存储后端支持
- **文件存储**：JSON格式本地持久化，支持向后兼容
- **数据库存储**：MySQL高性能索引查询，支持复杂条件筛选

#### 数据库表结构
```sql
-- 证据记录表
CREATE TABLE evidence_records (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    tx_id VARCHAR(36) NOT NULL COMMENT '交易ID',
    connector_id VARCHAR(100) NOT NULL COMMENT '连接器ID',
    event_type VARCHAR(50) NOT NULL COMMENT '事件类型',
    channel_id VARCHAR(36) NOT NULL COMMENT '频道ID',
    data_hash VARCHAR(128) DEFAULT '' COMMENT '数据哈希',
    signature TEXT COMMENT '数字签名',
    timestamp TIMESTAMP(6) NOT NULL COMMENT '时间戳',
    metadata JSON COMMENT '元数据',
    record_hash VARCHAR(128) NOT NULL COMMENT '记录哈希',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引优化
INDEX idx_tx_id (tx_id),
INDEX idx_connector_id (connector_id),
INDEX idx_event_type (event_type),
INDEX idx_channel_id (channel_id),
INDEX idx_timestamp (timestamp),
UNIQUE KEY uk_tx_event (tx_id, event_type)
```

### 4.5 查询与分析接口

#### 多维度查询能力
- **按交易ID查询**：追踪完整业务流程
- **按频道查询**：分析特定频道的所有活动
- **按连接器查询**：跟踪特定实体的操作历史
- **时间范围查询**：支持精确时间段筛选
- **复合条件查询**：支持多条件组合查询

#### gRPC服务接口
- **SubmitEvidence**：提交存证记录（带身份验证）
- **QueryEvidence**：查询存证记录（带权限控制）
- **VerifyEvidenceSignature**：验证数字签名真实性

#### 权限控制
- **身份验证**：基于mTLS证书的严格身份认证
- **访问控制**：只能查询自己参与的频道记录
- **审计追踪**：所有查询操作本身也会产生存证

### 4.7 性能优化特性

#### 高性能设计
- **异步处理**：存证操作不阻塞业务流程
- **批量写入**：累积多条记录后批量持久化
- **内存索引**：快速查询支持（TxID、ChannelID、ConnectorID）
- **连接池**：数据库连接池提高并发性能

#### 存储策略
- **文件存储**：简单可靠，适合小型部署
- **数据库存储**：高性能查询，适合大规模部署
- **混合存储**：文件+数据库双重保障

### 4.8 安全特性

#### 深度防御
- **传输层安全**：基于mTLS的加密传输
- **认证层安全**：RSA数字签名确保不可抵赖
- **数据层安全**：哈希链确保不可篡改
- **访问层安全**：细粒度权限控制

#### 完整性验证
```go
// 记录完整性验证
func (al *AuditLog) VerifyRecord(record *EvidenceRecord) error {
    calculatedHash := al.calculateRecordHash(record)
    if calculatedHash != record.Hash {
        return fmt.Errorf("hash mismatch: expected=%s, got=%s",
            record.Hash, calculatedHash)
    }
    return nil
}
```

### 4.9 监控与运维

#### 关键指标
- 证据生成速率（EPS）
- 查询响应时间
- 存储成功率
- 签名验证通过率
- 分布式分发成功率

#### 故障处理
- **存储失败**：自动降级到文件存储
- **网络分区**：本地缓存，网络恢复后同步
- **数据损坏**：通过多副本恢复
- **性能瓶颈**：自动扩容和索引优化

### 4.10 频道关联关系

```
数据频道 (ChannelTypeData)
├── 控制频道 (ChannelTypeControl) - 权限协商等控制信息
├── 存证频道 (ChannelTypeLog) - 分布式存证数据
│   ├── 主题格式: {data_topic}-evidence
│   ├── 参与者: 数据频道所有参与者
│   └── 传输内容: 结构化存证记录
└── 关联关系：数据频道知道存证频道ID，存证频道知道数据频道ID
```

这种设计确保了存证数据的**高可用性**、**容错性**和**不可抵赖性**，为整个可信数据空间提供了坚实的安全审计基础。

## 五、连接器功能特性

### 5.1 文件传输

**大文件传输支持：**
- **分块传输**：支持大文件分块传输，避免内存溢出
- **传输协议**：定义专门的文件传输协议（FILE_HEADER/FILE_CHUNK/FILE_END）
- **进度显示**：实时显示传输进度和速度
- **完整性验证**：传输完成后验证文件哈希

**文件传输流程：**
```
发送方 → 分割文件为数据块 → 发送文件头信息 → 逐块发送数据 → 发送结束标记
接收方 → 接收文件头 → 创建文件 → 逐块写入 → 验证完整性 → 完成回调
```

### 5.2 实时数据发送

**实时发送器（RealtimeSender）：**
- **流式传输**：支持持续的数据流发送
- **缓冲管理**：内部缓冲队列管理数据包
- **并发安全**：线程安全的发送操作
- **错误处理**：自动重连和错误恢复

### 5.3 连接器发现

**连接器发现服务：**
- **列表查询**：查询所有注册的连接器信息
- **状态监控**：实时监控连接器在线状态
- **信息查询**：获取特定连接器的详细信息
- **频道查询**：查询连接器参与的频道信息

### 5.4 频道订阅管理

**灵活的订阅机制：**
- **自动订阅**：频道创建时自动订阅相关连接器
- **手动订阅**：支持手动订阅指定频道
- **权限验证**：订阅时验证连接器的访问权限
- **状态同步**：实时同步频道状态变化

## 六、扩展性设计

**水平扩展**：

内核支持水平扩展部署：

```
               负载均衡器
                   │
      ┌────────────┼────────────┐
      ↓            ↓            ↓
   Kernel-1    Kernel-2    Kernel-3
      │            │            │
      └────────────┴────────────┘
               共享存储
           (审计日志、配置)
```

**扩展策略**：
- 无状态设计：连接器可连接任意内核实例
- 审计日志：集中存储到分布式数据库

