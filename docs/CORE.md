# 可信数据空间内核 - 核心模块说明

## 概述

我们设计的可信数据空间内核主要分为四个核心模块：安全认证、流通调度，管控模块、存证溯源。最终要实现内核标准化、轻量化，外延灵活易扩展的目标。

---

## 一、安全认证模块

### 1.1 核心构想

安全认证模块采用**基于证书的双向认证（mTLS）机制**，构建零信任安全架构。核心理念是：**任何实体在建立连接前都必须证明自己的身份，且每次通信都需要验证身份的真实性**。

### 1.2 证书体系架构

- **根证书（CA Certificate）**：自签名的根证书，作为整个信任体系的锚点，有效期通常为10年（之后若扩展到多个可信数据空间互联的情景，需要一个外部可信CA来签发）
- **服务端证书（Server Certificate）**：内核服务端持有的证书，由CA签发，用于向连接器证明内核身份
- **客户端证书（Client Certificate）**：每个连接器持有的证书，由CA签发，证书的CommonName字段必须与连接器ID一致

### 1.3 mTLS

**客户端认证服务端：**
- 连接器在连接时验证内核服务端证书
- 确保连接的是合法的内核服务，而非中间人
- 通过CA根证书验证服务端证书的合法性

**服务端认证客户端：**

- 内核在建立连接时强制要求客户端提供证书
- 验证证书的有效期、用途等属性

**大致过程**

- 先生成CA根证书（无可信CA机构的情况）
  - 生成ca.key 
  - 用 ca.key 自签生成 ca.crt
- 每个实体也生成自己的私钥
  - connector.key,kernel.key......
- 用各自公钥生成 CSR并用私钥签名
  - connector.csr,kernel.csr......
- 用 CA 对 CSR 进行签发，生成实体证书
  - 用 ca.crt + ca.key 签发得到connector.crt,kernel.crt......
- 材料准备完成后才能进行mtls相关过程

---

## 二、流通调度模块

### 3.1 核心构想

流通调度模块采用**频道（Channel）**来管理数据传输。频道是一个**逻辑上的数据传输管道**，并非直接连接发送方和接收方，而是提供数据的中转、缓冲和分发能力。

### 3.2 频道对象

**基本属性：**

- **唯一标识**：每个频道有全局唯一的频道ID（UUID）
- **参与方**：明确的发送方ID和接收方ID
- **状态**：Active或Closed

**核心组件：**

- **数据管道**：缓冲待分发的数据包（通常容量1000个数据包）
- **订阅者表**：维护订阅该频道的所有接收方通道
- **分发协程**：后台协程负责将数据从队列分发到所有订阅者

### 3.3 数据流转机制

**发布-订阅模式：**

频道采用订阅机制实现数据流转：

1. **频道创建**：发送方请求创建频道
   - 内核在创建时验证请求者是否为合法的发送方
   - 发送方在创建时指定接收方，这可能需要维护一个目录服务（比如之后的注册表），支持动态发现空间中其他连接器的ID，这样灵活性更高
   - 最简单的方式就是静态配置，直接在配置文件中写死目标ID，或者是双方线下沟通协商，再进行配置。但本质上都是静态的，灵活性很差
2. **数据订阅**：内核通知接收方订阅频道，获得数据通道
   - 订阅时验证订阅者是否为合法的接收方
   - 每个订阅者获得独立的缓冲通道（容量100个数据包）
   - 支持多个接收方同时订阅同一频道（广播模式）
3. **数据推送**：发送方将数据包推送到频道的缓冲队列（暂时想的是队列，总之就是一个起到管道传输作用的对象）
4. **数据分发**

# TBD...

---

## 三、管控模块

### 2.1 核心构想

管控模块负责**连接器的身份管理和数据传输的权限控制**。采用**注册表+权限策略**双重管控机制。

### 2.2 身份注册表机制

**连接器生命周期管理：**

身份注册表维护每个连接器的完整生命周期信息，包括：

- **身份信息**：连接器ID、实体类型、公钥
- **状态信息**：在线/离线状态、最后心跳时间、注册时间等
- **会话信息**：会话令牌（token）、连接状态

**健康检查机制（心跳检查）**：

**心跳机制概述：**

采用客户端定期发送心跳、服务端监控心跳的双向健康检查机制，确保连接器状态的实时监控和异常及时发现。

**客户端心跳发送：**
- **发送频率**：每15秒发送一次心跳
- **心跳内容**：包含连接器ID和时间戳
- **自动重连**：心跳失败时记录警告但不停服务

**服务端心跳监控：**
- **在线判断**：30秒内收到心跳即为在线
- **离线检测**：超过1分钟无心跳标记为离线
- **状态转换**：活跃/非活跃状态 → 离线状态

**状态管理逻辑：**
- **注册时**：新连接器默认为活跃状态
- **心跳更新**：收到心跳时更新最后心跳时间
- **状态恢复**：离线连接器收到心跳后恢复活跃状态
- **定期清理**：每30秒检查并标记离线连接器

### 2.3 权限策略（ACL）

**访问控制列表（ACL）机制：**

权限策略引擎采用基于规则的访问控制，支持：

- **精确匹配规则**：`senderID:receiverID` 精确匹配
- **通配符规则**：`senderID:*` 或 `*:receiverID` 支持通配符匹配
- **优先级控制**：规则支持优先级设置，高优先级规则优先匹配
- **默认策略**：当没有匹配规则时，使用默认策略（允许/拒绝）

**规则示例：**
```go
// 允许 connector-A 向 connector-B 发送数据
policyEngine.AddRule(&PolicyRule{
    SenderID:   "connector-A",
    ReceiverID: "connector-B",
    Allowed:    true,
    Priority:   100,
})

// 允许 connector-A 向所有连接器发送数据
policyEngine.AddRule(&PolicyRule{
    SenderID:   "connector-A",
    ReceiverID: "*",
    Allowed:    true,
    Priority:   50,
})
```

### 2.4 频道协商机制

**两阶段频道创建：**

频道创建采用协商机制，确保所有参与方同意后才建立通信渠道：

1. **频道提议**：创建者发起频道创建提议，指定发送方、接收方和批准者
2. **参与方确认**：所有发送方和接收方需要独立确认提议
3. **频道激活**：全部确认后频道变为活跃状态，可正常传输数据

**频道状态流转：**
```
Proposed → Active (所有参与方确认)
Proposed → Closed (任意参与方拒绝)
```

### 2.5 权限变更提议机制

**动态权限调整：**

频道运行过程中支持动态调整参与者权限，通过提议-批准机制实现：

- **权限变更类型**：添加/删除发送方，添加/删除接收方
- **申请流程**：频道参与者提交变更申请
- **批准机制**：由指定批准者审核和批准变更
- **安全约束**：确保至少保留一名发送方和接收方

**变更流程：**
```
申请变更 → 批准者审核 → 执行变更 → 即时生效
   ↓
安全验证 → 权限检查 → 审计记录
```

**访问控制流程：**

1. **频道创建时**：
   - 检查ACL权限（发送方→接收方）
   - 验证所有参与方在线状态
   - 协商机制确保多方同意

2. **数据传输时**：
   - 验证发送方权限
   - 检查频道活跃状态

3. **运行时调整**：
   - 支持动态添加/删除参与者
   - 权限变更需要批准者确认

--------------------------------------------------------------------------

## 四、存证模块

### 4.1 核心构想

存证模块采用**时间戳排序的哈希记录**方式记录所有关键操作，构建**可审计的存证日志**。核心理念是：**所有关键事件都必须记录，并通过哈希值确保记录完整性**。

### 4.2 记录结构

每个存证记录包含：
- **唯一标识**：交易ID（UUID）
- **事件信息**：连接器ID、事件类型、频道ID等
- **数据指纹**：数据哈希（而非原始数据）
- **时间戳**：精确到纳秒的事件发生时间
- **数字签名**：行为不可抵赖签名
- **内容哈希**：记录内容的SHA256哈希，用于完整性验证

### 4.3 分布式存储机制

**自动频道创建：**
- 创建数据传输频道时，系统自动创建配套的存证频道
- 存证频道包含所有数据传输的参与者（发送方+接收方）
- 频道主题格式：`{data_topic}-evidence`

**分布式传输：**
- 存证数据通过专用频道进行广播传输
- 所有参与主机都能接收并存储存证数据
- 实现真正的分布式存证，避免单点故障

**多层存储策略：**
- **频道传输**：实时分布式广播（主要存储）
- **本地持久化**：可选的本地文件备份
- **内存索引**：快速查询支持

### 4.4 完整性验证

通过计算记录内容的哈希值并与存储的哈希值对比，确保记录未被篡改。分布式存储确保即使部分节点故障，存证数据仍能从其他节点恢复。

### 4.5 频道关联关系

```
数据频道 (ChannelTypeData)
├── 控制频道 (ChannelTypeControl) - 权限协商等控制信息
├── 存证频道 (ChannelTypeLog) - 分布式存证数据
└── 关联关系：数据频道知道存证频道ID，存证频道知道数据频道ID
```

这种设计确保了存证数据的高可用性和容错性。

